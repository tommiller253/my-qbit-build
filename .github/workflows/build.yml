name: CI - macOS (GUI & NOX Dual Build)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch: # This adds a "Run Workflow" button in GitHub Actions

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  ci:
    name: Build
    runs-on: macos-latest
    permissions:
      actions: write

    strategy:
      fail-fast: false
      matrix:
        # This creates two parallel jobs: one for GUI, one for Terminal (NOX)
        qbt_gui: ["GUI=ON", "GUI=OFF"]
        libt_version: ["1.2.20"]
        qt_version: ["6.10.1"]

    env:
      boost_path: "${{ github.workspace }}/../boost"
      libtorrent_path: "${{ github.workspace }}/../libtorrent"

    steps:
      - name: Checkout qBittorrent
        uses: actions/checkout@v4
        with:
          ref: 'release-5.1.4' # Pulls the stable 5.1.4 code
          persist-credentials: false

      - name: Install dependencies
        run: |
          brew update > /dev/null
          brew install openssl@3 zlib cmake ninja

      - name: Setup ccache
        uses: Chocobo1/setup-ccache-action@v1
        with:
          ccache_options: |
            max_size=1G

      - name: Install boost
        run: |
          boost_url="https://archives.boost.io/release/1.86.0/source/boost_1_86_0.tar.gz"
          curl -L -o "${{ runner.temp }}/boost.tar.gz" "$boost_url"
          tar -xf "${{ runner.temp }}/boost.tar.gz" -C "${{ github.workspace }}/.."
          mv "${{ github.workspace }}/.."/boost_* "${{ env.boost_path }}"
          cd "${{ env.boost_path }}"
          ./bootstrap.sh
          ./b2 stage --stagedir=./ --with-headers

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.qt_version }}
          archives: qtbase qtdeclarative qtsvg qttools
          modules: qtimageformats
          cache: true

      - name: Install libtorrent (1.2.20)
        run: |
          git clone --branch v${{ matrix.libt_version }} --depth 1 --recurse-submodules https://github.com/arvidn/libtorrent.git ${{ env.libtorrent_path }}
          cd ${{ env.libtorrent_path }}
          cmake -B build -G "Ninja" -DBUILD_SHARED_LIBS=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=20 -DBOOST_ROOT="${{ env.boost_path }}/lib/cmake"
          cmake --build build
          sudo cmake --install build

      - name: Build qBittorrent
        run: |
          cmake -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DBOOST_ROOT="${{ env.boost_path }}/lib/cmake" -D${{ matrix.qbt_gui }}
          cmake --build build
          
      - name: Prepare build artifacts
        run: |
          appName="qbittorrent"
          if [ "${{ matrix.qbt_gui }}" = "GUI=OFF" ]; then
            appName="qbittorrent-nox"
          fi
          
          pushd build
          if [ "${{ matrix.qbt_gui }}" = "GUI=ON" ]; then
            macdeployqt "$appName.app" -no-strip
            # Ad-hoc signing for M2 silicon compatibility
            codesign --force --sign - "$appName.app"
            hdiutil create -fs HFS+ -srcfolder "$appName.app" -volname "$appName" "$appName.dmg"
          else
            # For NOX, we just need the binary
            chmod +x "$appName"
          fi
          popd

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: qBittorrent_${{ matrix.qbt_gui }}_LibT1.2
          path: |
            build/*.dmg
            build/qbittorrent-nox
