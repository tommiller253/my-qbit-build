name: CI - macOS (Lib 1.2 Target)

on:
  workflow_dispatch: # This adds the "Run" button you need
  push:
    branches: [ master, main ]

permissions:
  contents: read
  actions: write

jobs:
  ci:
    name: Build
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        # Narrowed down to exactly what you requested
        libt_version: ["1.2.20"]
        qbt_gui: ["GUI=ON", "GUI=OFF"]
        qt_version: ["6.10.1"]

    env:
      boost_path: "${{ github.workspace }}/../boost"
      libtorrent_path: "${{ github.workspace }}/../libtorrent"

    steps:
      - name: Checkout qBittorrent
        uses: actions/checkout@v4
        with:
          repository: qbittorrent/qBittorrent
          ref: 'release-5.1.4' # Pinning to the stable 5.1.4 version
          persist-credentials: false

      - name: Install dependencies
        run: |
          brew update > /dev/null
          brew install openssl@3 zlib cmake ninja

      - name: Install boost
        run: |
          curl -L -o "${{ runner.temp }}/boost.tar.gz" https://archives.boost.io/release/1.86.0/source/boost_1_86_0.tar.gz
          tar -xf "${{ runner.temp }}/boost.tar.gz" -C "${{ github.workspace }}/.."
          mv "${{ github.workspace }}/.."/boost_* "${{ env.boost_path }}"
          cd "${{ env.boost_path }}"
          ./bootstrap.sh
          ./b2 stage --stagedir=./ --with-headers

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.qt_version }}
          archives: qtbase qtdeclarative qtsvg qttools
          modules: qtimageformats
          cache: true

      - name: Install libtorrent (1.2.20)
        run: |
          git clone --branch v${{ matrix.libt_version }} --depth 1 --recurse-submodules https://github.com/arvidn/libtorrent.git ${{ env.libtorrent_path }}
          cd ${{ env.libtorrent_path }}
          cmake -B build -G "Ninja" -DBUILD_SHARED_LIBS=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=20 -DBOOST_ROOT="${{ env.boost_path }}/lib/cmake"
          cmake --build build
          sudo cmake --install build

      - name: Build qBittorrent
        run: |
          cmake -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DBOOST_ROOT="${{ env.boost_path }}/lib/cmake" -D${{ matrix.qbt_gui }}
          cmake --build build

      - name: Prepare build artifacts
        run: |
          appName="qbittorrent"
          if [ "${{ matrix.qbt_gui }}" = "GUI=OFF" ]; then appName="qbittorrent-nox"; fi
          pushd build
          if [ "${{ matrix.qbt_gui }}" = "GUI=ON" ]; then
            macdeployqt "$appName.app" -no-strip
            codesign --force --sign - "$appName.app" # Required for M2
            hdiutil create -fs HFS+ -srcfolder "$appName.app" -volname "$appName" "$appName.dmg"
          else
            chmod +x "$appName"
          fi
          popd

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qBittorrent_macOS_Lib1.2_${{ matrix.qbt_gui }}
          path: |
            build/*.dmg
            build/qbittorrent-nox
