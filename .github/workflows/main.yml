name: Build and Release qBittorrent (M2)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        libt_version: ["1.2.20"]
        qbt_gui: ["GUI=ON", "GUI=OFF"]
        qt_version: ["6.8.1"] # Switched to 6.8.1 LTS for stability

    steps:
      - name: Checkout qBittorrent
        uses: actions/checkout@v4
        with:
          repository: qbittorrent/qBittorrent
          ref: 'release-5.1.4'

      - name: Install dependencies
        run: brew install openssl@3 zlib cmake ninja boost

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.qt_version }}
          cache: true

      - name: Build libtorrent
        run: |
          git clone --branch v${{ matrix.libt_version }} --depth 1 --recurse-submodules https://github.com/arvidn/libtorrent.git ../libtorrent
          cmake -B ../libtorrent/build -S ../libtorrent -G "Ninja" -DCMAKE_BUILD_TYPE=Release -Dboost-python=OFF -Dencryption=ON -Dpython-bindings=OFF
          cmake --build ../libtorrent/build
          sudo cmake --install ../libtorrent/build

      - name: Build qBittorrent
        run: |
          cmake -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release -D${{ matrix.qbt_gui }}
          cmake --build build

      - name: Prepare Artifacts
        run: |
          mkdir -p upload
          if [ "${{ matrix.qbt_gui }}" = "GUI=ON" ]; then
            # Handle GUI Bundle
            macdeployqt "build/qbittorrent.app" -no-strip
            codesign --force --sign - "build/qbittorrent.app"
            hdiutil create -fs HFS+ -srcfolder "build/qbittorrent.app" -volname "qBittorrent" "upload/qBittorrent-GUI.dmg"
          else
            # Handle NOX (The "Search and Rescue" Fix)
            # Find the binary even if it's hidden inside a .app folder
            BIN_PATH=$(find build -name "qbittorrent-nox" -type f | grep "MacOS" || find build -name "qbittorrent-nox" -type f)
            echo "Found binary at: $BIN_PATH"
            cp "$BIN_PATH" "upload/qbittorrent-nox"
            chmod +x "upload/qbittorrent-nox"
            codesign --force --sign - "upload/qbittorrent-nox"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          tag_name: "v5.1.4-L1.2"
          name: "qBittorrent 5.1.4 (LibT 1.2.20)"
          files: |
            upload/qBittorrent-GUI.dmg
            upload/qbittorrent-nox
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
