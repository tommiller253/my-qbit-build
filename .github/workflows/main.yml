name: Build qBittorrent 5.1.2 for macOS ARM

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build_gui:
    name: Build GUI DMG
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install cmake ninja openssl@3 zlib boost

      - name: Install Qt 6.7.0
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.7.0
          archives: qtbase qtdeclarative qtsvg qttools
          cache: true

      - name: Build libtorrent 1.2.20
        run: |
          git clone --branch v1.2.20 --depth 1 https://github.com/arvidn/libtorrent.git libtorrent
          cd libtorrent
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_INSTALL_PREFIX=$PWD/install \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DBOOST_ROOT=$(brew --prefix boost) \
            -DBoost_NO_SYSTEM_PATHS=ON
          cmake --build build
          cmake --install build

      - name: Clone qBittorrent 5.1.2
        run: |
          git clone --branch v5.1.2 --depth 1 https://github.com/qbittorrent/qBittorrent.git qBittorrent

      - name: Build GUI
        run: |
          cd qBittorrent
          mkdir build && cd build
          cmake ../ -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DGUI=ON \
            -DQT6=ON \
            -DUSE_SYSTEM_LIBTORRENT=ON \
            -DLIBTORRENT_ROOT=$PWD/../../libtorrent/install \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake --build . --parallel

      - name: Package GUI app
        run: |
          cd qBittorrent/build
          macdeployqt qBittorrent.app -dmg -no-strip
          codesign --force --deep --options runtime --sign - qBittorrent.app

      - name: Create GUI DMG
        run: |
          mkdir -p upload
          hdiutil create -volname qBittorrent -srcfolder qBittorrent/build/qBittorrent.app -ov -format UDZO upload/qBittorrent-5.1.2-GUI-arm64.dmg

      - name: Upload GUI DMG
        uses: actions/upload-artifact@v4
        with:
          name: GUI-DMG
          path: upload/qBittorrent-5.1.2-GUI-arm64.dmg

  build_nox:
    name: Build NOX DMG
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install cmake ninja openssl@3 zlib boost

      - name: Install Qt 6.7.0
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.7.0
          archives: qtbase qtdeclarative qtsvg qttools
          cache: true

      - name: Build libtorrent 1.2.20
        run: |
          git clone --branch v1.2.20 --depth 1 https://github.com/arvidn/libtorrent.git libtorrent
          cd libtorrent
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_INSTALL_PREFIX=$PWD/install \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DBOOST_ROOT=$(brew --prefix boost) \
            -DBoost_NO_SYSTEM_PATHS=ON
          cmake --build build
          cmake --install build

      - name: Clone qBittorrent 5.1.2
        run: |
          git clone --branch v5.1.2 --depth 1 https://github.com/qbittorrent/qBittorrent.git qBittorrent

      - name: Build NOX
        run: |
          cd qBittorrent
          mkdir build && cd build
          cmake ../ -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DGUI=OFF \
            -DQT6=ON \
            -DUSE_SYSTEM_LIBTORRENT=ON \
            -DLIBTORRENT_ROOT=$PWD/../../libtorrent/install \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake --build . --parallel

      - name: Package NOX app
        run: |
          cd qBittorrent/build
          macdeployqt qbittorrent-nox.app -dmg -no-strip
          codesign --force --deep --options runtime --sign - qbittorrent-nox.app

      - name: Create NOX DMG
        run: |
          mkdir -p upload
          hdiutil create -volname qbittorrent-nox -srcfolder qBittorrent/build/qbittorrent-nox.app -ov -format UDZO upload/qBittorrent-5.1.2-NOX-arm64.dmg

      - name: Upload NOX DMG
        uses: actions/upload-artifact@v4
        with:
          name: NOX-DMG
          path: upload/qBittorrent-5.1.2-NOX-arm64.dmg
